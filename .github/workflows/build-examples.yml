name: Build ESP32-S2 Mini Sketches

on:
  push:
    branches: 
      - main
      - feature/enomik
  pull_request:
    branches: 
      - main
      - feature/enomik

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "${GITHUB_WORKSPACE}/bin" >> $GITHUB_PATH
          
      - name: Configure Arduino CLI
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          
      - name: Install library dependencies
        run: |
          # Create Arduino libraries directory
          mkdir -p $HOME/Arduino/libraries
          
          # Symlink this repository as a library so examples can find it
          ln -s $GITHUB_WORKSPACE $HOME/Arduino/libraries/ESP-NOW-MIDI
          
          # Install any external dependencies (add more as needed)
          arduino-cli lib install "Adafruit TinyUSB Library"
          arduino-cli lib install "Adafruit_MPU6050"
          arduino-cli lib install "Mozzi"
          arduino-cli lib install "SparkFun DMX Shield Library"
          arduino-cli lib install "AceButton"
          
      - name: Compile all examples
        run: |
          mkdir -p build
          for sketch in examples/*/; do
            if [ -d "$sketch" ]; then
              sketch_name=$(basename "$sketch")
              echo "Building $sketch_name"
              arduino-cli compile --fqbn esp32:esp32:esp32s2 "$sketch" --output-dir build/"$sketch_name" || echo "Failed to build $sketch_name"
            fi
          done
          
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: esp32s2-bin-files
          path: build/